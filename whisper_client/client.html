<!doctype>
<html>

<head>
    <title>Whisper Application</title>
    <link rel="stylesheet" type="text/css" href="../style/style.css" />
    <script type="text/javascript" src="../js/web3.min.js"></script>
    <script type="text/javascript" src="../js/ipfs.js"></script>
    <script type="text/javascript" src="../js/jsencrypt.js"></script>
    <script type="text/javascript">

    /* create application namespace */
    let App = {}
    App.conf = {}

    /* configuration initialization */
    App.conf.web3Host;
    App.conf.web3Port;
    App.conf.ipfsHost;
    App.conf.ipfsAPIPort;
    App.conf.whisperBuyUrl;    
    
    /* whisper intialization */
    App.publicKey;
    App.privateKey;
    App.fileReceived = {};
    App.crypto = new JSEncrypt();
    
    /* ipfs initialization */
    let ipfs;
    App.ipfs = ipfs;

    /* web3 initialization */
    let Web3 = require('web3');
    App.web3 = new Web3();
    
    /* HTML Table Configuration */
    /* configuration html table */
    App.html = new Object();
    App.html.tableRowCounter = new Object()

    App.html.appConfigurationTable = 'AppConfigurationTable';
    App.html.htmlConfData = new Object();
    App.html.htmlConfRowID = -1;
    App.html.tableRowCounter[App.html.appConfigurationTable] = function (key) {
        if(App.html.htmlConfData.hasOwnProperty(key)) {
            return App.html.htmlConfData[key];
        } else {
            App.html._htmlConfRowID += 1;
            return App.html.htmlConfRowID;    
        }
    }

    /* files bought html table */
    App.html.inventoryTable = 'InventoryTable';
    App.html.htmlInventoryData = new Object();
    App.html.htmlInventoryRowID = -1;
    App.html.tableRowCounter[App.html.inventoryTable] = function (key) {
        if(App.html.htmlInventoryData.hasOwnProperty(key)) {
            return App.html.htmlInventoryData[key];
        } else {
            App.html.htmlInventoryRowID += 1;
            return App.html.htmlInventoryRowID;    
        };
    };
    
    function insertRowInHtmlTable(tableName, key, value) {
        htmlTable = document.getElementById(tableName);
        row = htmlTable.insertRow(App.html.tableRowCounter[tableName](key));
        row.insertCell(0).innerHTML = key;
        row.insertCell(1).innerHTML = value;
    };

    /**
     * Check for the File API support.
     */
    function checkFileAPI() {
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            reader = new FileReader();
            return true; 
        } else {
            alert('The File APIs are not fully supported by your browser. Fallback required.');
            return false;
        }
    }

    /**
     * read text input
     */
    function readText(filePath, callback) {
        let reader = new FileReader();
        if(!checkFileAPI()) {
            alert('file api not available, open app on chrome!');
        }

        if(filePath.files && filePath.files[0]) {           
            reader.onload = function (e) {
                output = e.target.result;
                callback(output);
            };//end onload()
            reader.readAsText(filePath.files[0]);
        }
    }

    /**
     * set App.config
     */
    function setAppConfig(filePath) {
        readText(filePath, function load(txt) { 
            
            let data = JSON.parse(txt)
            
            App.conf.web3Host = data.web3.host; // 'http://localhost';
            App.conf.web3Port = data.web3.port; // '8545';
            App.conf.ipfsHost = data.ipfs.host;
            App.conf.ipfsAPIPort = data.ipfs.api_port;
            App.conf.whisperBuyUrl = data.whisper.buy_url;
            
            App.web3.setProvider(new App.web3.providers.HttpProvider(App.conf.web3Host + ':' + App.conf.web3Port));
            if (!App.web3.isConnected()) {
                console.error("Ethereum - no connection to RPC server");
            } else {
                console.log("Ethereum - connected to RPC server");
            }
            App.account = App.web3.eth.accounts[0];

            /* IPFS initialization */
            App.ipfs = IpfsApi(App.conf.ipfsHost, App.conf.ipfsAPIPort)
            
            let key1 = 'Ethereum Provider';
            let value1 = App.conf.web3Host + ':' + App.conf.web3Port;
            insertRowInHtmlTable(App.html.appConfigurationTable, key1, value1);
            

            let key2 = 'IPFS Node'
            let value2 = App.conf.ipfsHost + ':' + App.conf.ipfsAPIPort
            insertRowInHtmlTable(App.html.appConfigurationTable, key2, value2);
        });
    }
  
    function displayHTML(eid, data) {
        document.getElementById(eid).innerText = data;
    }
    
    /**
     * set App.privateKey
     */
    function setPrivateKey(filePath) {
        readText(filePath, function setKeys(data) { 
            App.privateKey = data;
            App.crypto.setPrivateKey(App.privateKey);
            insertRowInHtmlTable(App.html.appConfigurationTable, 'Private Key', '(valid)');
        });        
    }

    /**
     * set App.publicKey
     */
    function setPublicKey(filePath) {
        readText(filePath, function setKeys(data) { 
            App.publicKey = data;
            App.crypto.setPublicKey(App.publicKey);
            insertRowInHtmlTable(App.html.appConfigurationTable, 'Public Key', '(valid)');
        });        
    }

    /**
     * whisper after contract is fulfilled
     */
    function requestWhisper(fileName) {

        if(fileName == null) {
            fileName = document.getElementById("buyFileName").value
        }

        // http request object
        let http = new XMLHttpRequest();
        http.open("POST", App.conf.whisperBuyUrl);
        http.setRequestHeader("Content-Type", "application/json;charset=UTF-8");        
        //Call this function when the state changes
        http.onreadystatechange = function() {
            if(http.readyState == 4 && http.status == 200) {
                let ipfsEncryptedFileUrl = http.responseText;

                // console output
                console.log('server returned : ' + ipfsEncryptedFileUrl);
                
                let ipfsFileUrl = App.crypto.decrypt(ipfsEncryptedFileUrl);

                // console output
                console.log('decrypted server returned : ' + ipfsFileUrl)

                App.fileReceived[fileName] = ipfsFileUrl;

                insertRowInHtmlTable(App.html.inventoryTable, fileName, ipfsFileUrl);
                alert('Total ' + Object.keys(App.fileReceived).length + ' file (s) retrieved');
            }
        }

        let whisperObject = {}
        whisperObject.PublicKey = App.publicKey
        whisperObject.FileName = fileName
        http.send(JSON.stringify(whisperObject));
    }

    /**
     * whisper after contract is fulfilled
     */
    function checkWhisper(fileName) {
        if(fileName == null) {
            fileName = document.getElementById("inventoryFileName").value;
        }
        hash = App.fileReceived[fileName];
        App.ipfs.cat(hash, function (err, stream) {
          let res = '';

          stream.on('data', function (chunk) {
            res += chunk.toString();
          });

          stream.on('error', function (err) {
            console.error('checkWhisper: ', err);    
          });

          stream.on('end', function () {
            document.getElementById("whisperOutputStr").innerText = App.crypto.decrypt(res);
          });
        });
    }

    /**
      * Check the balance in the current eth account
      **/
    function ethereumStatus() {
        let status = {}
        status.balance = getBalance()
        status.gasprice = App.web3.eth.gasPrice
        return status
    }

    /**
      * Check the balance in the current eth account
      **/
    function whisperStatus() {
        let status = {}
        status.filesReceived = App.fileReceived
        status.filesSent = App.fileSent
        return status
    }


    /**
      * Check the balance in the current eth account
      **/
    function getBalance() {
        // Print balance in all the accounts
        App.web3.eth.getBalance(App.account, function (err, balance) {
            return parseFloat(App.web3.fromWei(balance, "ether"));
        });
    }
    </script>
</head>

<body>
    <br/>
    <h2>Whisper Client</h2>

    <strong>App configuration</strong>: 
    <input type="file" name="appConfig" onchange='setAppConfig(this)' />
    <strong>Public Key</strong>: 
    <input type="file" name="publicKey" onchange='setPublicKey(this)' />
    
    <strong>Private Key</strong>: 
    <input type="file" name="privateKey" onchange='setPrivateKey(this)' />

    <table id="AppConfigurationTable"></table>

    <fieldset>
      <label>Buy file: </label>
      <input type = "text" id = "buyFileName" />
      <input type = "button" value = "Buy" onclick = "requestWhisper()"/>
    </fieldset>
    <br>
    <br>
    <h2>Inventory</h2>
    <table id="InventoryTable"></table>
    <br>
    <br>
    <h2>Whispers</h2>
    <fieldset>
      <label>Decrypt file: </label>
      <input type = "text" id = "inventoryFileName" />
      <input type = "button" value = "decrypt" onclick = "checkWhisper()"/>
      <p><strong><output id="whisperOutputStr">None</output></strong></p>
    </fieldset>
</body>
