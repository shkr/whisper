<!doctype>
<html>

<head>
    <title>Whisper Application</title>
    <link rel="stylesheet" type="text/css" href="./style/style.css" />
    <script type="text/javascript" src="./web3/web3.min.js"></script>
    <script type="text/javascript" src="./rsa/jsencrypt.js"></script>
    <script type="text/javascript">

    /* create application namespace */
    let App = {}

    /* configuration initialization */
    App.web3Host; // 'http://localhost';
    App.web3Port; // '8545';
    App.whisperUrl; // "/whisper"

    /* crypto intialization */
    App.publicKey;
    App.privateKey;
    App.fileReceived = new Set();
    App.fileSent = new Set();
    App.decrypt = new JSEncrypt();
    

    /* web3 initialization */
    let Web3 = require('web3');
    App.web3 = new Web3();
    web3.setProvider(new web3.providers.HttpProvider(web3Host + ':' + web3Port));
    if (!web3.isConnected()) {
        console.error("Ethereum - no connection to RPC server");
    } else {
        console.log("Ethereum - connected to RPC server");
    }
    App.account = web3.eth.accounts[0];
    
    /**
     * Check for the letious File API support.
     */
    function checkFileAPI() {
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            reader = new FileReader();
            return true; 
        } else {
            alert('The File APIs are not fully supported by your browser. Fallback required.');
            return false;
        }
    }

    /**
     * read text input
     */
    function readText(filePath, callback) {
        let reader = new FileReader();
        if(!checkFileAPI()) {
            alert('file api not available, open app on chrome!');
        }

        if(filePath.files && filePath.files[0]) {           
            reader.onload = function (e) {
                output = e.target.result;
                callback(output);
            };//end onload()
            reader.readAsText(filePath.files[0]);
        }
    }

    /**
     * set App.config
     */
    function setAppConfig(filePath) {
        readText(filePath, function setKeys(data) { 
            let jsonData = data
            App.web3Host = jsonData.eth.host; // 'http://localhost';
            App.web3Port = sonData.eth.port; // '8545';
            App.whisperUrl = jsonData.whisper; // "/whisper"
        });
    }

    
    /**
     * set App.privateKey
     */
    function setPrivateKey(filePath) {
        readText(filePath, function setPk(data) { 
            App.privateKey = data;
            decrypt.setPrivateKey(App.privateKey);
        });        
    }

    /**
     * whisper after contract is fulfilled
     */
    function whisperToClient(fileName) {

        // http request object
        let http = new XMLHttpRequest();
        http.open("POST", whisperUrl);
        http.setRequestHeader("Content-Type", "application/json;charset=UTF-8");        
        //Call this function when the state changes
        http.onreadystatechange = function() {
            if(http.readyState == 4 && http.status == 200) {
                let encryptedFileName = http.responseText;
                let uncrypted = decrypt.decrypt(encryptedFileName);
                App.fileReceived.add(uncrypted);
                alert(App.fileReceived.size + " file (s) retrieved");
            }
        }

        let whisperObject = {}
        whisperObject.PublicKey = publicKey
        whisperObject.FileName = fileName
        http.send(JSON.stringify(whisperObject));
    }


    /* smart contract interface */
    App.contractInterface = [{
        "constant": false,
        "inputs": [{
            "name": "public_key",
            "type": "string"
        }, {
            "name": "eth",
            "type": "int"
        }],
        "name": "request",
        "outputs": [{
            "name": "address",
            "type": "string"
        }],
        "type": "function"
    }];

    
    App.contract = App.web3.eth.contract(contractInterface);
    App.contractObject = {
        from: account,
        gas: 300000,
        data: '0xcontractinbytes',
    };

    /** 
      * Publish a new contract this has to be done using the go client
      **/
    function publishContract() {

        window.currentData = null;

        if (window.contractInstance) {
            console.error('Contract already been deployed at: ', window.contractAddress);
            return;
        }

        window.contract.new(window.contractObject, function (err, contract) {
            if (err) {
                console.error("Contract deployment error: ", err);
            } else if (contract.address) {
                window.contractAddress = contract.address;
                window.contractInstance = window.contract.at(contract.address);
                console.log("Contract successfully deployed at: ", contract.address);
            } else if (contract.transactionHash) {
                console.log("Awaiting contract deployment with transaction hash: ", contract.transactionHash);
            } else {
                console.error("Unresolved contract deployment error");
            }
        });
    }

    /**
      * View the purchased files
      **/
    function viewDataSent(fileName) {
        
        if (!window.contractInstance) {
            console.error("Storage contract has not been deployed");
            return;
        }

        window.contractInstance.get.call(function (err, result) {
            if (err) {
                console.error("Content fetch error:", err);
            } else if (result && window.IPFSHash == result) {
                console.log("New data is not mined yet. Current data: ", result);
                return;
            } else if (result) {
                window.IPFSHash = result;
                let URL = window.ipfsAddress + "/" + result;
                console.log("Content successfully retrieved. IPFS address", result);
                console.log("Content URL:", URL);
            } else {
                console.error('No data, verify the transaction has been mined');
            }
        });
    }

    /**
      * Check the balance in the current eth account
      **/
    function ethereumStatus() {
        let status = {}
        status.balance = getBalance()
        status.gasprice = App.web3.eth.gasPrice
    }

    /**
      * Check the balance in the current eth account
      **/
    function whisperStatus() {
        let status = {}
        status.filesReceived = App.fileReceived
        status.filesSent = App.fileSent
    }


    /**
      * Check the balance in the current eth account
      **/
    function getBalance() {
        // Print balance in all the accounts
        App.web3.eth.getBalance(App.account, function (err, balance) {
            return parseFloat(App.web3.fromWei(balance, "ether"));
        });
    }
    </script>
</head>

<body>
    <br/>
    <h2>whisper web application</h2>

    <hr/>
    <br/>

    <p>Configuration files:</p>
    <p>
    <strong>App configuration</strong>: 
    <input type="file" name="appConfig" onchange='setPublicKey(this)' />
    </p>
    <p>
    <strong>Public Key</strong>: 
    <input type="file" name="publicKey" onchange='setPublicKey(this)' />
    </p>
    <p>
    <strong>Private Key</strong>: 
    <input type="file" name="privateKey" onchange='setPrivateKey(this)' />
    </p>

    <p> Ethereum Info </p>

    <p> IPFS Info </p>

    <p> Whisper Info </p>

    <p> Publish files </p>

    <ol>
        <li><code>publishContract()</code>: Deploy the whisper contract to your Ethereum blockchain. The geth client will show it received the deployment transaction, return a transaction hash to the console, and print out the contract transaction address after successful deployment.</li>
        <br/>
    </ol>

    <p>Purchase files:</p>

    <ol>
        <li><code>buyData(filePath, eth)</code>: buy the file at the location with [eth] coins.</li>
        <br/>
    </ol>

    <br/>

    <hr/>
    <br/>

    <br />

    <p>Here is a concrete example. Let's say we want to upload an image of the <a href="https://ethereum.org/images/wallpaper-homestead.jpg">Ethereum Homestead wallpaper</a>. For example purposes, my IPFS hash address for this wallpaper resolves to "QmPJLNMiAp3QoCKdGAgzshNRbQiZ8wQmyjYkcUHJZzQ19u". Then we have all the pieces to run the storage application.</p>

    <p>Run the commands:</p>
    <ol>
        <li>geth --datadir="./ethdata/" account new</li>
        <li>
        <li><code>deployStorage()</code></li>
        <li><code>storeContent("https://ethereum.org/images/wallpaper-homestead.jpg")</code></li>
        <li><code>storeAddress("QmPJLNMiAp3QoCKdGAgzshNRbQiZ8wQmyjYkcUHJZzQ19u")</code></li>
        <li><code>fetchContent()</code></li>
    </ol>

    <p>This process will then return: "http://localhost:8080/ipfs/QmPJLNMiAp3QoCKdGAgzshNRbQiZ8wQmyjYkcUHJZzQ19u"</p>

    <br/>
    <hr/>
    <br/>

    <br/>
    <hr/>
</body>
